
name: Build SDK (Android)

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-android:
    strategy:
      matrix:
        ue-version: ['5.2']
    runs-on: [ self-hosted, Windows, X64, w10-1344 ]
    steps:
    - uses: actions/checkout@v4
    - name: git-update-dependecies
      run: git submodule update --init --recursive
    - uses: actions/download-artifact@v4
      with:
        name: NDK-Android
        path: InworldAI/Source/ThirdParty/InworldAINDKLibrary
    - name: Copy NDK
      run: |
          $pythonPath = (Get-Command python.exe).Source
          $process = Start-Process -FilePath $pythonPath -Wait -NoNewWindow -PassThru -ArgumentList build-scripts\ndk-util.py,--copy
          if($process.ExitCode -ne 0)
          {
            exit 1
          }
    - name: Copy Template - First Person
      shell: pwsh
      run: |
          Copy-Item -Path "C:\Program Files\Epic Games\UE_${{ matrix.ue-version }}\Templates\TP_FirstPerson"  -Destination "TP_FirstPerson" -Recurse
    - name: Copy Plugins & Remove Assets
      shell: pwsh
      run: |
          Remove-Item "InworldAI\Content\*" -Recurse -ErrorAction SilentlyContinue
          Remove-Item "TP_FirstPerson\Plugins\InworldAI" -Recurse -ErrorAction SilentlyContinue
          Remove-Item "TP_FirstPerson\Plugins\InworldMetahuman" -Recurse -ErrorAction SilentlyContinue
          Remove-Item "TP_FirstPerson\Plugins\InworldInnequin" -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path "InworldAI"  -Destination "TP_FirstPerson\Plugins\InworldAI" -Recurse
          Copy-Item -Path "InworldMetahuman"  -Destination "TP_FirstPerson\Plugins\InworldMetahuman" -Recurse
          Copy-Item -Path "InworldInnequin"  -Destination "TP_FirstPerson\Plugins\InworldInnequin" -Recurse
    - name: BuildGame-android-${{ matrix.ue-version }}
      shell: pwsh
      run: |
          [string]$UEPath = "C:\Program Files\Epic Games\UE_${{ matrix.ue-version }}"
          [string]$ProjectPath = "$pwd"
          Start-Process -FilePath "$UEPath\Engine\Build\BatchFiles\RunUAT.bat" -ArgumentList BuildGame,-Project="$ProjectPath\TP_FirstPerson\TP_FirstPerson.uproject",-platform=Android,-notools,-configuration=Development+Shipping," > BuildGameLog.txt" -Wait -NoNewWindow -PassThru
          cat BuildGameLog.txt
          if (Select-String -Path BuildGameLog.txt -Pattern "BUILD SUCCESSFUL" -SimpleMatch -Quiet)
          {
            exit 0
          }
          else
          {
            exit 1
          }
    - name: BuildPlugin-android-${{ matrix.ue-version }}
      shell: pwsh
      run: |
          [string]$UEPath = "C:\Program Files\Epic Games\UE_${{ matrix.ue-version }}"
          [string]$ProjectPath = "$pwd"
          Start-Process -FilePath "$UEPath\Engine\Build\BatchFiles\RunUAT.bat" -ArgumentList BuildPlugin,-plugin="$ProjectPath\TP_FirstPerson\Plugins\InworldAI\InworldAI.uplugin",-TargetPlatforms=Android,-package="$ProjectPath\PluginBuild"," > BuildPluginLog.txt" -Wait -NoNewWindow -PassThru
          cat BuildPluginLog.txt
          if (Select-String -Path BuildPluginLog.txt -Pattern "BUILD SUCCESSFUL" -SimpleMatch -Quiet)
          {
            exit 0
          }
          else
          {
            exit 1
          }
